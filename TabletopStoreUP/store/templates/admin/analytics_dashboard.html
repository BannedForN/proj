{% extends "admin/base_site.html" %}
{% block title %}–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á—ë—Ç—ã{% endblock %}

{% block content %}
<h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞</h1>

<form method="get" class="form-inline mb-3">
  <label>–ü–µ—Ä–∏–æ–¥:</label>
  <input type="date" name="start_date" value="{{ start_date }}" class="form-control mx-2">
  <input type="date" name="end_date" value="{{ end_date }}" class="form-control mx-2">
  <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
  <a href="{% url 'export_analytics_csv' %}?start_date={{ start_date }}&end_date={{ end_date }}" class="btn btn-success ml-3">‚¨á –≠–∫—Å–ø–æ—Ä—Ç CSV</a>
</form>

<hr>

<div class="row mb-4">
  <div class="col-md-3"><strong>–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤:</strong> {{ total_orders }}</div>
  <div class="col-md-3"><strong>–û–±—â–∞—è –≤—ã—Ä—É—á–∫–∞:</strong> {{ total_revenue|floatformat:2 }} ‚ÇΩ</div>
  <div class="col-md-3"><strong>–°—Ä–µ–¥–Ω–∏–π —á–µ–∫:</strong> {{ avg_check|floatformat:2 }} ‚ÇΩ</div>
  <div class="col-md-3"><strong>–ü–æ–∫—É–ø–∞—Ç–µ–ª–µ–π:</strong> {{ unique_customers }}</div>
</div>

<hr>

<h2>üìà –í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º</h2>
<canvas id="revenueChart" width="800" height="300"></canvas>

<h2 class="mt-4">ü•á –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã</h2>
<canvas id="productChart" width="600" height="300"></canvas>

<h2 class="mt-4">üë• –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –¥–Ω—è–º</h2>
<canvas id="userChart" width="800" height="300"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- –í—ã—Ä—É—á–∫–∞ –ø–æ –¥–Ω—è–º ---
const revenueLabels = [{% for d in daily_revenue %}'{{ d.order_date__date }}',{% endfor %}];
const revenueData = [{% for d in daily_revenue %}{{ d.total|default:0 }},{% endfor %}];

new Chart(document.getElementById('revenueChart'), {
  type: 'line',
  data: {
    labels: revenueLabels,
    datasets: [{
      label: '–í—ã—Ä—É—á–∫–∞ (‚ÇΩ)',
      data: revenueData,
      borderColor: 'blue',
      fill: false,
      tension: 0.2
    }]
  }
});

// --- –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã ---
const productLabels = [{% for p in popular_products %}'{{ p.product__name }}',{% endfor %}];
const productData = [{% for p in popular_products %}{{ p.total_sold|default:0 }},{% endfor %}];

new Chart(document.getElementById('productChart'), {
  type: 'pie',
  data: {
    labels: productLabels,
    datasets: [{
      data: productData,
      backgroundColor: [
        '#007bff','#28a745','#ffc107','#dc3545','#6f42c1','#17a2b8','#20c997','#fd7e14','#6610f2','#e83e8c'
      ]
    }]
  }
});

// --- –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –¥–Ω—è–º ---
const userLabels = [{% for u in user_activity %}'{{ u.order_date__date }}',{% endfor %}];
const userData = [{% for u in user_activity %}{{ u.total_orders|default:0 }},{% endfor %}];

new Chart(document.getElementById('userChart'), {
  type: 'bar',
  data: {
    labels: userLabels,
    datasets: [{
      label: '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–∫–∞–∑–æ–≤',
      data: userData,
      backgroundColor: '#17a2b8'
    }]
  }
});
</script>
{% endblock %}
